<!DOCTYPE html>
<html lang="en">

<head>
    <title>Ghost Registry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 40px;
            max-width: 600px;
            margin: auto;
            background: #f4f7f6;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        h2 {
            margin-top: 0;
            color: #333;
        }

        label {
            font-weight: 600;
            color: #555;
            display: block;
            margin-bottom: 5px;
            margin-top: 15px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }

        button {
            background: #000;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.8;
        }

        .keys-display {
            font-family: monospace;
            font-size: 0.85em;
            background: #eee;
            padding: 10px;
            border-radius: 6px;
            word-break: break-all;
            color: #555;
            display: none;
            margin-top: 15px;
        }
    </style>
</head>

<body>

    <div class="card">
        <h2>üìù Register Name</h2>
        <p>Claim your username and publish your stealth keys on-chain.</p>

        <label>Choose Username</label>
        <input type="text" id="username" placeholder="e.g. satoshi">

        <button id="btnConnect" onclick="registerUser()">Connect Wallet & Register</button>

        <div id="status" style="margin-top:15px; color:blue; display:none;"></div>

        <div id="keyLog" class="keys-display"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const REGISTRY_ADDRESS = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0"; // <--- PASTE YOUR DEPLOYED REGISTRY ADDRESS HERE

        const LOCAL_CHAIN_ID_HEX = "0x7A69"; // 31337 in Hex
        const LOCAL_RPC_URL = "http://127.0.0.1:8545";

        const ec = new elliptic.ec('secp256k1');

        async function registerUser() {
            const name = document.getElementById("username").value;
            const status = document.getElementById("status");
            const keyLog = document.getElementById("keyLog");

            if (!name) return alert("Enter a name");

            status.style.display = "block";
            status.innerText = "Initializing...";

            try {
                if (!window.ethereum) throw new Error("No Metamask found");

                // 1. Switch Network logic
                await switchNetwork();

                // 2. Generate Keys locally
                status.innerText = "Generating Stealth Keys...";
                const scanKey = ec.genKeyPair();
                const spendKey = ec.genKeyPair();

                const scanPriv = "0x" + scanKey.getPrivate('hex');
                const scanPub = "0x" + scanKey.getPublic(false, 'hex'); // Uncompressed
                const spendPub = "0x" + spendKey.getPublic(false, 'hex'); // Uncompressed
                const spendPriv = "0x" + spendKey.getPrivate('hex');

                keyLog.style.display = "block";
                keyLog.innerHTML = `
                    <strong>GENERATED LOCAL KEYS:</strong><br>
                    <span style="color:red">SAVE THIS (Spend Private):</span> ${spendPriv}<br><br>
                    Scan Public: ${scanPub.substring(0, 20)}...<br>
                    Spend Public: ${spendPub.substring(0, 20)}...
                `;

                // 3. Connect Metamask
                status.innerText = "Connecting Wallet...";
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();

                status.innerText = "Please sign transaction in MetaMask...";

                // 4. Call Contract
                const abi = [
                    "function register(string, bytes, bytes, bytes32)"
                ];
                const contract = new ethers.Contract(REGISTRY_ADDRESS, abi, signer);

                const tx = await contract.register(name, scanPub, spendPub, scanPriv);

                status.innerText = "Transaction sent: " + tx.hash;
                await tx.wait();

                status.innerText = "‚úÖ Registration Complete! You are now in the Registry.";
                status.style.color = "green";

            } catch (err) {
                console.error(err);
                status.innerText = "Error: " + err.message;
                status.style.color = "red";
            }
        }

        async function switchNetwork() {
            try {
                // Try to switch to the local chain
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: LOCAL_CHAIN_ID_HEX }],
                });
            } catch (switchError) {
                // This error code means the chain has not been added to MetaMask.
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [
                                {
                                    chainId: LOCAL_CHAIN_ID_HEX,
                                    chainName: 'Local Anvil',
                                    rpcUrls: [LOCAL_RPC_URL],
                                    nativeCurrency: {
                                        name: 'ETH',
                                        symbol: 'ETH',
                                        decimals: 18
                                    }
                                },
                            ],
                        });
                    } catch (addError) {
                        throw new Error("Failed to add local network: " + addError.message);
                    }
                } else {
                    throw new Error("Failed to switch network: " + switchError.message);
                }
            }
        }
    </script>
</body>

</html>